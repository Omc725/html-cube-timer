<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cube Timer</title>
    
    <meta name="theme-color" content="#191a1c"/>
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="manifest" href="./manifest.json">

    <style>
        :root {
            --bg-dark: #1f2023; --bg-main: #27282c; --bg-sidebar: #191a1c;
            --bg-widget: #2d2e32; --text-primary: #e2e2e2; --text-secondary: #9a9a9a;
            --border-color: #3a3b40; --accent-blue: #3c82f6; --accent-green: #34d399;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #000; color: var(--text-primary); margin: 0;
            overflow: hidden; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .container { display: flex; height: 100vh; background-color: #000; }

        /* === Ana İçerik Alanı === */
        .main-content {
            flex-grow: 1; display: flex; flex-direction: column; width: 100%;
            height: 100vh; padding-bottom: 70px; /* Alttaki menü için boşluk */
        }
        .view { display: none; height: 100%; overflow-y: auto; padding: 20px; }
        .view.active { display: flex; flex-direction: column; }
        
        /* === Zamanlayıcı Görünümü === */
        #timer-view { padding: 10px; text-align: center; }
        .scramble-container { padding: 20px 10px 10px; font-size: 1.2em; font-weight: 500; color: var(--text-secondary); line-height: 1.5; }
        .timer-main { flex-grow: 1; display: flex; justify-content: center; align-items: center; }
        #timer { font-size: 100px; font-weight: 500; }
        .timer-footer { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; padding: 10px; }
        .stats-col { text-align: left; font-size: 0.9em; line-height: 1.6; }
        .stats-col div { display: flex; justify-content: space-between; }
        .stats-col .label { color: var(--text-secondary); }
        .stats-col .value { font-weight: 600; }
        .cube-visualization { display: grid; grid-template-columns: repeat(12, 12px); grid-template-rows: repeat(9, 12px); margin: auto; }
        .sticker { width: 12px; height: 12px; border: 1px solid #000; }

        /* === Çözümler Görünümü === */
        #solves-view { padding-bottom: 20px; }
        .solves-header { padding: 10px 0 20px; font-size: 1.5em; font-weight: 600; }
        .solves-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .solve-card { background-color: var(--bg-widget); border-radius: 12px; padding: 15px; text-align: center; }
        .solve-card .date { font-size: 0.8em; color: var(--text-secondary); }
        .solve-card .time { font-size: 1.5em; font-weight: 600; margin-top: 5px; }

        /* === İstatistikler Görünümü === */
        #stats-view h2 { font-weight: 600; text-align: center; }
        .chart-container { height: 300px; margin-bottom: 20px; }
        .stats-table { background-color: var(--bg-widget); border-radius: 12px; padding: 15px; }
        .stats-table .row { display: flex; justify-content: space-between; padding: 10px 5px; border-bottom: 1px solid var(--border-color); }
        .stats-table .row:last-child { border-bottom: none; }
        .stats-table .label { color: var(--text-secondary); font-weight: 500; }
        .stats-table .value { font-weight: 600; }

        /* === Alt Sekme Menüsü === */
        #bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            display: flex; justify-content: space-around;
            background-color: #111; border-top: 1px solid var(--border-color);
            padding: 10px 0; padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        #bottom-nav button {
            background: none; border: none; color: var(--text-secondary); cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 12px;
        }
        #bottom-nav button svg { width: 24px; height: 24px; }
        #bottom-nav button.active { color: var(--text-primary); }

    </style>
</head>
<body>
    <div class="container">
        <main class="main-content">
            <div id="timer-view" class="view active">
                <div class="scramble-container" id="scramble">Yükleniyor...</div>
                <div class="timer-main" id="timer-touch-area"><h1 id="timer">0.00</h1></div>
                <div class="timer-footer">
                    <div class="stats-col" id="stats-col-left"></div>
                    <div class="cube-visualization" id="cube-net"></div>
                    <div class="stats-col" id="stats-col-right" style="text-align: right;"></div>
                </div>
            </div>
            
            <div id="solves-view" class="view">
                <div class="solves-header">Çözümler</div>
                <div class="solves-grid" id="solves-grid"></div>
            </div>

            <div id="stats-view" class="view">
                <h2>İstatistikler</h2>
                <div class="chart-container"><canvas id="solves-chart"></canvas></div>
                <div class="stats-table" id="stats-table"></div>
            </div>
        </main>
    </div>

    <nav id="bottom-nav">
        <button class="nav-btn active" data-view="timer-view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 7h-2v5.414l3.293 3.293 1.414-1.414L13 11.586z"></path></svg>
            Zamanlayıcı
        </button>
        <button class="nav-btn" data-view="solves-view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"></path></svg>
            Çözümler
        </button>
        <button class="nav-btn" data-view="stats-view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 3v17a1 1 0 0 0 1 1h17v-2H5V3H3z"></path><path d="M21 5.414-14 18.414l-4.293-4.293-1.414 1.414L14 21.243l12-12L21 5.414z"></path></svg>
            İstatistikler
        </button>
    </nav>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let timerInterval, time=0, isRunning=false, readyToStart=false, solves=[], currentScramble='', chartInstance=null;
        const timerEl=document.getElementById('timer'), scrambleEl=document.getElementById('scramble');
        const cubeNetEl=document.getElementById('cube-net'), chartCanvas=document.getElementById('solves-chart');
        const timerTouchArea = document.getElementById('timer-touch-area');
        const bottomNav = document.getElementById('bottom-nav');
        const colors={W:'#fefefe',G:'#34d399',R:'#ef4444',B:'#3c82f6',O:'#f97316',Y:'#eab308'};

        function createSolvedState(){return[...Array(9).fill('W'),...Array(9).fill('O'),...Array(9).fill('G'),...Array(9).fill('R'),...Array(9).fill('B'),...Array(9).fill('Y')]}
        const stickerMap={U:[0,1,2,3,4,5,6,7,8],L:[9,10,11,12,13,14,15,16,17],F:[18,19,20,21,22,23,24,25,26],R:[27,28,29,30,31,32,33,34,35],B:[36,37,38,39,40,41,42,43,44],D:[45,46,47,48,49,50,51,52,53]};
        const adjacentMap={U:[38,37,36,29,28,27,20,19,18,11,10,9],D:[15,16,17,24,25,26,33,34,35,42,43,44],F:[6,7,8,27,30,33,47,46,45,15,12,9],B:[2,1,0,17,14,11,51,52,53,29,32,35],L:[0,3,6,18,21,24,45,48,51,44,41,38],R:[8,5,2,36,39,42,53,50,47,26,23,20]};
        function rotate(state,face,modifier){const fS=stickerMap[face],aS=adjacentMap[face],t=modifier==="'"?3:(modifier==="2"?2:1);for(let i=0;i<t;i++){const nF=[...fS.map(idx=>state[idx])],rF=[nF[6],nF[3],nF[0],nF[7],nF[4],nF[1],nF[8],nF[5],nF[2]];fS.forEach((idx,j)=>state[idx]=rF[j]);const nA=aS.slice(0,3).map(idx=>state[idx]);for(let j=0;j<9;j++){state[aS[j]]=state[aS[j+3]]}aS.slice(9).forEach((idx,j)=>state[idx]=nA[j])}return state}
        function applyScramble(scrambleStr){let state=createSolvedState();scrambleStr.split(' ').filter(m=>m).forEach(move=>state=rotate(state,move[0],move.length>1?move[1]:''));return state}
        function createCubeNetHTML(container){const l={U:{r:1,c:4,f:0},L:{r:4,c:1,f:1},F:{r:4,c:4,f:2},R:{r:4,c:7,f:3},B:{r:4,c:10,f:4},D:{r:7,c:4,f:5}};container.innerHTML='';for(const f in l){for(let i=0;i<3;i++){for(let j=0;j<3;j++){const s=document.createElement('div');s.classList.add('sticker');s.style.gridRow=l[f].r+i;s.style.gridColumn=l[f].c+j;s.id=`${container.id}-s-${l[f].f*9+(i*3+j)}`;container.appendChild(s)}}}}
        function drawCubeNet(container,state){for(let i=0;i<54;i++){const s=document.getElementById(`${container.id}-s-${i}`);if(s)s.style.backgroundColor=colors[state[i]]}}
        
        function formatTime(ms){if(ms===Infinity||isNaN(ms)||ms===null)return'--';return(ms/1000).toFixed(2)}
        function startTimer(){time=0;isRunning=true;timerEl.style.color='var(--text-primary)';const sT=Date.now();timerInterval=setInterval(()=>{time=Date.now()-sT;timerEl.textContent=formatTime(time)},10)}
        function stopTimer(){isRunning=false;clearInterval(timerInterval);addSolve({time,scramble:currentScramble,date:new Date().toISOString()});generateNewScramble()}
        function addSolve(solveData){solves.unshift(solveData);updateAll()}
        
        function updateAll(){
            saveSolves();
            renderStats();
            renderSolvesGrid();
            if(document.getElementById('stats-view').classList.contains('active')){
                drawChart();
            }
        }
        function calculateAverage(count,list){if(list.length<count)return null;const times=list.slice(0,count).map(s=>s.time).sort((a,b)=>a-b).slice(1,-1);return times.reduce((a,b)=>a+b,0)/times.length}
        function calculateMean(list) { if(list.length === 0) return null; return list.reduce((a, b) => a + b.time, 0) / list.length; }
        function calculateStdDev(list) {
            if(list.length < 2) return null;
            const mean = calculateMean(list);
            const times = list.map(s => s.time);
            return Math.sqrt(times.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / times.length);
        }

        function renderStats() {
            const times = solves.map(s => s.time);
            const best = solves.length ? Math.min(...times) : null;
            const mean = calculateMean(solves);
            const stdDev = calculateStdDev(solves);
            const count = solves.length;
            const ao5 = calculateAverage(5, solves);
            const ao12 = calculateAverage(12, solves);
            const ao50 = calculateAverage(50, solves);
            const ao100 = calculateAverage(100, solves);

            const statsLeftCol = document.getElementById('stats-col-left');
            statsLeftCol.innerHTML = `
                <div><span class="label">Sapma:</span><span class="value">${formatTime(stdDev)}</span></div>
                <div><span class="label">Ortalama:</span><span class="value">${formatTime(mean)}</span></div>
                <div><span class="label">En iyi:</span><span class="value">${formatTime(best)}</span></div>
                <div><span class="label">Sayılan:</span><span class="value">${count}</span></div>
            `;
            const statsRightCol = document.getElementById('stats-col-right');
            statsRightCol.innerHTML = `
                <div><span class="label">Ao5:</span><span class="value">${formatTime(ao5)}</span></div>
                <div><span class="label">Ao12:</span><span class="value">${formatTime(ao12)}</span></div>
                <div><span class="label">Ao50:</span><span class="value">${formatTime(ao50)}</span></div>
                <div><span class="label">Ao100:</span><span class="value">${formatTime(ao100)}</span></div>
            `;
            
            const statsTable = document.getElementById('stats-table');
            statsTable.innerHTML = `
                <div class="row"><span class="label">Sapma</span><span class="value">${formatTime(stdDev)}</span></div>
                <div class="row"><span class="label">Ao12</span><span class="value">${formatTime(ao12)}</span></div>
                <div class="row"><span class="label">Ao50</span><span class="value">${formatTime(ao50)}</span></div>
                <div class="row"><span class="label">Ao100</span><span class="value">${formatTime(ao100)}</span></div>
                <div class="row"><span class="label">En İyi</span><span class="value">${formatTime(best)}</span></div>
                <div class="row"><span class="label">Sayılan</span><span class="value">${count}</span></div>
            `;
        }

        function renderSolvesGrid() {
            const grid = document.getElementById('solves-grid');
            grid.innerHTML = solves.map(solve => {
                const date = new Date(solve.date);
                const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                return `
                    <div class="solve-card">
                        <div class="date">${formattedDate}</div>
                        <div class="time">${formatTime(solve.time)}</div>
                    </div>
                `;
            }).join('');
        }

        function generateNewScramble(){const m=["U","D","L","R","F","B"],d=["","'","2"];let s="",l="";for(let i=0;i<21;i++){let v,a,p=getAxis(l);do{v=m[Math.floor(Math.random()*m.length)];a=getAxis(v)}while(a===p);s+=v+d[Math.floor(Math.random()*d.length)]+" ";l=v}currentScramble=s.trim();scrambleEl.textContent=currentScramble;drawCubeNet(cubeNetEl,applyScramble(currentScramble))}
        function getAxis(move){if(['U','D'].includes(move))return'Y';if(['L','R'].includes(move))return'X';if(['F','B'].includes(move))return'Z';return null}
        
        function handleInteractionStart(){if(isRunning){stopTimer()}else if(!readyToStart){timerEl.textContent='0.00';timerEl.style.color='var(--accent-red)';readyToStart=true}}
        function handleInteractionEnd(){if(!isRunning&&readyToStart){timerEl.style.color='var(--accent-green)';startTimer()}readyToStart=false}
        
        function setupEventListeners(){
            document.addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();handleInteractionStart()}});
            document.addEventListener('keyup',e=>{if(e.code==='Space'){handleInteractionEnd()}});
            timerTouchArea.addEventListener('touchstart',e=>{e.preventDefault();handleInteractionStart()});
            timerTouchArea.addEventListener('touchend',e=>{e.preventDefault();handleInteractionEnd()});

            bottomNav.addEventListener('click', e => {
                const navBtn = e.target.closest('.nav-btn');
                if (!navBtn) return;
                
                document.querySelector('.nav-btn.active').classList.remove('active');
                document.querySelector('.view.active').classList.remove('active');
                
                navBtn.classList.add('active');
                const viewId = navBtn.dataset.view;
                document.getElementById(viewId).classList.add('active');
                
                if (viewId === 'stats-view') drawChart();
            });
        }
        function drawChart(){if(chartInstance)chartInstance.destroy();const labels=solves.map((_,i)=>solves.length-i).reverse();const data=solves.map(s=>s.time/1000).reverse();chartInstance=new Chart(chartCanvas,{type:'line',data:{labels,datasets:[{label:'Her Şey',data,borderColor:'#FFF',tension:0.1}]},options:{responsive:true,maintainAspectRatio:false}})}
        
        function saveSolves(){localStorage.setItem('cubeTimerMobile',JSON.stringify(solves))}
        function loadSolves(){const saved=localStorage.getItem('cubeTimerMobile');if(saved){solves=JSON.parse(saved)}}
        function init(){createCubeNetHTML(cubeNetEl);loadSolves();generateNewScramble();updateAll();setupEventListeners()}
        init();

        if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js').then(reg=>console.log('SW registered.')).catch(err=>console.log('SW registration failed:',err))})}
    });
    </script>
</body>
</html>
